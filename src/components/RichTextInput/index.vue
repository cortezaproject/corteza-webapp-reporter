<template>
  <b-card
    no-body
    class="editor rt-content"
  >
    <template v-if="editor">
      <b-card-header header-class="p-0 rounded-sm">
        <editor-menu-bar
          v-slot="{ commands, isActive, getMarkAttrs, getNodeAttrs }"
          :editor="editor"
        >
          <r-toolbar
            :editor="editor"
            :formats="toolbar"
            :commands="commands"
            :is-active="isActive"
            :get-mark-attrs="getMarkAttrs"
            :get-node-attrs="getNodeAttrs"
          />
        </editor-menu-bar>
      </b-card-header>

      <b-card-body>
        <editor-content
          class="editor__content"
          :editor="editor"
        />
      </b-card-body>
    </template>
  </b-card>
</template>

<script>
import RToolbar from './RToolbar'
import { EditorMenuBar, Editor, EditorContent } from 'tiptap'

import { getFormats, getToolbar } from './lib'

export default {
  components: {
    EditorContent,
    RToolbar,
    EditorMenuBar,
  },

  props: {
    value: {
      type: String,
      required: false,
      default: null,
    },
  },

  data () {
    const formats = getFormats()
    return {
      formats,
      toolbar: getToolbar(),
      // Helper to determine if current content differes from prop's content
      emittedContent: false,
      editor: undefined,
    }
  },

  watch: {
    value: {
      handler: function (val) {
        // Update happened due to external content change, not model change
        if (!this.emittedContent) {
          this.editor.setContent(val)
        }

        this.emittedContent = false
      },
      deep: true,
    },
  },

  mounted () {
    this.init()
  },

  beforeDestroy () {
    this.editor.destroy()
  },

  methods: {
    /**
     * Initialize the editor, state, ...
     */
    init () {
      this.editor = new Editor({
        extensions: this.formats,
        content: this.value,
        onUpdate: this.onUpdate,
      })

      /**
       * Since we migrated to TipTap, the new content should be emitted
       * after tiptap is done parsing it.
       */
      this.$nextTick(() => {
        this.onUpdate()
      })
    },

    /**
     * Handle on update events. Process current document & update data model
     * @note Currently, build-in toHTML function removes empty lines.
     * Because of this, we are using `view.dom.innerHTML`. This should be improved at a later point
     */
    onUpdate () {
      let content = this.editor.view.dom.innerHTML

      // Makes sure to default to '' as the value if no text is present, for validation purposes
      content = content !== '<p><br></p>' ? content : ''

      this.emittedContent = true
      this.$emit('input', content)
    },
  },
}
</script>
